 <!DOCTYPE html>

<html class="h-full" lang="th">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Forklift-rental-dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<style>
      :root {
        --primary-color: #1F6FB2;  /* ฟ้าโลโก้ */
        --secondary-color: #FF7A1A; /* ส้มโลโก้ */
        --dark-text: #1e293b;
        --muted-text: #64748b;
        --bg-soft: #f5f7fb;
        --card-border: #e2e8f0;
      }
  
      * { box-sizing: border-box; }
  
      body {
        margin: 0;
        padding: 0;
        font-family: 'Prompt', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--bg-soft);
      }
  
      .main-wrapper {
        min-height: 100vh;
        padding: 2rem 1rem;
        background: var(--bg-soft);
      }
  
      .card {
        background: #ffffff;
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid rgba(15, 23, 42, 0.05);
        box-shadow: 0 10px 26px rgba(15, 23, 42, 0.04);
        margin-bottom: 1rem;
      }
  
      .card-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark-text);
        margin: 0 0 1rem 0;
      }
  
      /* Stats */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 1.25rem;
        margin-bottom: 0.75rem;
      }
      @media (max-width: 900px) {
        .stats-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      }
      @media (max-width: 600px) {
        .stats-grid { grid-template-columns: 1fr; }
      }
  
      .dashboard-card {
        position: relative;
        border-radius: 18px;
        box-shadow: 0 2px 12px #b6c6e21a;
        background: #fff;
        padding: 2.6rem 1.2rem 1.5rem;
        transition: box-shadow 0.2s, transform 0.1s;
        border: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 190px;
      }
      .dashboard-card:hover {
        box-shadow: 0 8px 24px #b6c6e23a;
        transform: translateY(-2px);
      }
  
      .icon-bg {
        position: absolute;
        left: 50%;
        top: 0;
        transform: translate(-50%, -50%);
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 20%, #ffe7cf 0%, #ffd2a3 35%, #ffc48a 70%, #ffb36b 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 15px rgba(255, 122, 26, 0.35);
        font-size: 1.4rem;
      }
      /* Icon color (orange) */
      .icon-bg i {
        color: var(--secondary-color);
      }
      /* Recolor PNG icon to orange */
      .icon-bg img {
        width: 30px;
        height: 30px;
        display: block;
        filter: brightness(0) saturate(100%) invert(56%) sepia(90%) saturate(1865%) hue-rotate(345deg) brightness(102%) contrast(101%);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0.1rem 0;
        text-align: center;
      }
      .stat-title {
        font-size: 0.9rem;
        color: #7a8aa7;
        margin-top: 0.2rem;
        text-align: center;
      }
      .stat-breakdown {
        margin-top: 0.3rem;
        font-size: 0.78rem;
        color: #1f2937;
        width: 100%;
        max-width: 180px;
      }
      .stat-breakdown-row {
        display: flex;
        justify-content: space-between;
        gap: 0.75rem;
        font-weight: 600;
      }
      .stat-breakdown-row span:first-child {
        letter-spacing: 0.03em;
      }
      .stat-breakdown-row span:last-child {
        min-width: 40px;
        text-align: right;
        color: #1f2937;
      }
  
      /* Layout grid */
      .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.25rem;
        margin-bottom: 1rem;
      }
      @media (max-width: 968px) {
        .content-grid { grid-template-columns: 1fr; }
      }
  
      /* Simple tables */
      .simple-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
      }
      .simple-table thead tr {
        background: #e5edf8;
        color: #1f2937;
      }
      .simple-table th,
      .simple-table td {
        padding: 0.5rem;
      }
      .simple-table th {
        font-weight: 600;
        text-align: left;
      }
      .simple-table td {
        border-bottom: 1px solid #edf2f7;
      }
  
          /* Charts */
      .chart-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.25rem;
        margin-top: 0.5rem;
      }
      @media (max-width: 768px) {
        .chart-grid { grid-template-columns: 1fr; }
      }
      .chart-card {
        background: #f9fbff;
        border-radius: 12px;
        border: 1px solid #e5edf8;
        padding: 1rem 1.25rem;
      }
      .chart-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--dark-text);
        margin-bottom: 0.4rem;
      }
      .chart-subtitle {
        font-size: 0.75rem;
        color: var(--muted-text);
        margin-bottom: 0.6rem;
      }
  
      .chart-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
      }
  
      .chart-filters select {
        padding: 0.3rem 0.75rem;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        font-size: 0.8rem;
        font-family: 'Prompt', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        color: #374151;
      }
      /* กราฟแท่งแนวตั้ง */
      .chart-bars {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 0.75rem;
        height: 180px;
        padding: 0.25rem 0.25rem 0.1rem;
      }
      .chart-bar-col {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        height: 100%;
        gap: 0.35rem;
        font-size: 0.78rem;
      }
      .chart-bar-outer {
        height: 100%;
        display: flex;
        align-items: flex-end;
        width: 100%;
        max-width: 26px;
        background: #e5edf8;
        border-radius: 8px;
        overflow: hidden;
      }
      .chart-bar {
        width: 100%;
        border-radius: 8px 8px 0 0;
      }
      .chart-bar.contracts {
        background: linear-gradient(180deg, var(--primary-color), #4fa0e6);
      }
      .chart-bar.revenue {
        background: linear-gradient(180deg, var(--secondary-color), #ff9b42);
      }
      .chart-value {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--dark-text);
      }
      .chart-label {
        font-size: 0.78rem;
        color: var(--muted-text);
        text-align: center;
      }
  
      /* Lists */
      .scroll-list {
        max-height: 320px;
        overflow-y: auto;
        padding-right: 4px;
        margin-right: -4px;
      }
  
      .contract-item {
        padding: 1rem;
        border-radius: 12px;
        background: #f9fbff;
        margin-bottom: 0.75rem;
        border: 1px solid #e5edf8;
      }
      .contract-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.4rem;
      }
      .contract-id {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--dark-text);
      }
      .status-badge {
        display: inline-block;
        padding: 0.2rem 0.7rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .status-active {
        background: #e3f0ff;
        color: var(--primary-color);
      }
      .status-pending {
        background: #fff3dc;
        color: #b45309;
      }
      .status-approved {
        background: #e0fcef;
        color: #047857;
      }
      .contract-amount {
        font-weight: 700;
        font-size: 1.05rem;
        color: var(--primary-color);
        margin-bottom: 0.25rem;
      }
      .contract-details {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: var(--muted-text);
        gap: 0.75rem;
      }
      .contract-meta {
        list-style-type: disc;
        padding-left: 1.1rem;
        margin: 0.15rem 0 0;
        font-size: 0.78rem;
        color: var(--muted-text);
      }
  
      .quotation-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0.9rem 0;
        border-bottom: 1px solid #edf2f7;
      }
      .quotation-item:last-child { border-bottom: none; }
      .quotation-info h4 {
        margin: 0 0 0.15rem 0;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--dark-text);
      }
      .quotation-info p {
        margin: 0;
        font-size: 0.8rem;
        color: var(--muted-text);
      }
      .quotation-meta {
        list-style-type: disc;
        padding-left: 1.1rem;
        margin: 0.25rem 0 0;
        font-size: 0.78rem;
        color: var(--muted-text);
      }
      .quotation-amount {
        font-size: 1rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0 0 0.3rem 0;
        text-align: right;
      }
  
      /* Timeline */
      .payment-timeline { position: relative; }
      .timeline-item {
        position: relative;
        padding-left: 2rem;
        padding-bottom: 1.1rem;
      }
      .timeline-item:last-child { padding-bottom: 0; }
      .timeline-item::before {
        content: '';
        position: absolute;
        left: 0.45rem;
        top: 0.6rem;
        bottom: -1.1rem;
        width: 2px;
        background: #e2e8f0;
      }
      .timeline-item:last-child::before { display: none; }
      .timeline-dot {
        position: absolute;
        left: 0;
        top: 0.25rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: #ffffff;
        border: 3px solid var(--secondary-color);
      }
      .timeline-content h4 {
        margin: 0 0 0.15rem 0;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--dark-text);
      }
      .timeline-content p {
        margin: 0 0 0.2rem 0;
        font-size: 0.78rem;
        color: var(--muted-text);
      }
      .timeline-amount {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--primary-color);
      }
  
      /* Fleet summary */
      .financial-summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.9rem;
        margin-top: 0.5rem;
      }
      .summary-item {
        padding: 0.85rem 0.9rem;
        background: #f9fbff;
        border-radius: 12px;
        border: 1px solid #e5edf8;
      }
      .summary-item.warning {
        background: #fff7e6;
        border-color: #fed7aa;
      }
      .summary-label {
        font-size: 0.8rem;
        color: var(--muted-text);
        margin-bottom: 0.3rem;
        font-weight: 500;
      }
      .summary-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-color);
      }
      .alert-box {
        padding: 0.85rem;
        background: #fff7e6;
        border-radius: 12px;
        border: 1px solid #fed7aa;
        margin-top: 0.8rem;
        font-size: 0.8rem;
        color: #b45309;
      }
      .alert-title {
        font-weight: 600;
        margin-bottom: 0.35rem;
      }
      .alert-item { margin-bottom: 0.15rem; }
      .maintenance-list {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        margin-top: 0.25rem;
      }
      .maintenance-card {
        padding: 0.45rem 0.7rem;
        border-radius: 10px;
        background: #ffffff;
        border: 1px solid #fed7aa;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.78rem;
        color: #b45309;
      }
      .maintenance-card span:first-child {
        font-weight: 700;
      }
  
      /* แถวหัวข้อการ์ด + ปุ่มด้านขวา */
      .card-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
  
      /* ปุ่ม "สัญญาเช่าทั้งหมด" */
      .card-link-btn {
        font-size: 0.8rem;
        padding: 0.4rem 1.2rem;
        border-radius: 999px;
        border: none;
        background: #1F6FB2; /* blue */
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(31, 111, 178, 0.35);
        transition: background 0.15s, box-shadow 0.15s, transform 0.1s;
      }
  
            .card-link-btn:hover {
        background: #185a95;
        box-shadow: 0 6px 14px rgba(31, 111, 178, 0.45);
        transform: translateY(-1px);
        color: #ffffff;
      }

      /* Agent dropdown top-right */
      .sale-dropdown {
        position: relative;
      }
      .sale-toggle-btn {
        padding: 0.4rem 1.4rem;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--dark-text);
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(15,23,42,0.08);
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }
      .sale-toggle-btn:hover {
        background: #f9fafb;
      }
      .sale-dropdown-menu {
        position: absolute;
        right: 0;
        top: calc(100% + 0.4rem);
        min-width: 190px;
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 12px 30px rgba(15,23,42,0.18);
        padding: 0.4rem 0;
        display: none;
        z-index: 20;
      }
      .sale-dropdown-menu a {
        display: block;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        color: #111827;
        text-decoration: none;
        white-space: nowrap;
      }
      .sale-dropdown-menu a:hover {
        background: #f3f4ff;
        color: var(--primary-color);
      }
      .sale-dropdown-menu a.active {
        font-weight: 600;
        background: #e5edf8;
        color: var(--primary-color);
      }
      .sale-dropdown.open .sale-dropdown-menu {
        display: block;
      }
    
      /* Multi-select dropdown (checkbox) */
      .mdrop{position:relative;width:100%;}
      .mdrop-btn{width:100%;display:flex;align-items:center;justify-content:space-between;gap:0.75rem;
        padding:0.55rem 0.75rem;border-radius:10px;border:1px solid #e5e7eb;background:#fff;
        font-family:'Prompt',sans-serif;cursor:pointer;}
      .mdrop-btn:focus{outline:none;box-shadow:0 0 0 3px rgba(31,111,178,0.18);}
      .mdrop-caret{opacity:0.7;}
      .mdrop-panel{position:absolute;left:0;right:0;top:calc(100% + 8px);z-index:50;
        background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 28px rgba(2,6,23,0.12);
        padding:0.5rem;display:none;max-height:280px;overflow:auto;}
      .mdrop.open .mdrop-panel{display:block;}
      .mdrop-actions{display:flex;gap:0.5rem;justify-content:flex-end;position:sticky;top:0;background:#fff;padding-bottom:0.5rem;margin-bottom:0.25rem;border-bottom:1px solid #f1f5f9;}
      .mdrop-action{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:0.35rem 0.7rem;cursor:pointer;font-weight:600;font-size:0.78rem;}
      .mdrop-action:hover{background:#f8fafc;}
      .mdrop-list{display:flex;flex-direction:column;gap:0.25rem;}
      .mdrop-item{display:flex;align-items:center;gap:0.55rem;padding:0.45rem 0.55rem;border-radius:10px;cursor:pointer;}
      .mdrop-item:hover{background:#f8fafc;}
      .mdrop-item input{width:16px;height:16px;}
      .mdrop-item span{font-size:0.9rem;color:#0f172a;}

    
      .chart-canvas-wrap{position:relative; height:260px; width:100%;}
      .chart-canvas-wrap canvas{width:100% !important; height:100% !important;}
/* ==== FIX: icon not overflow card + align top equally ==== */
.dashboard-card{
  position: relative;
  overflow: hidden;
  padding-top: 78px; /* space for icon */
}
.dashboard-card .icon-bg{
  top: 14px !important;
  transform: translateX(-50%) !important; /* keep centered, no Y lift */
}
.dashboard-card .stat-value{ margin-top: 10px; }
/* small screens */
@media (max-width: 520px){
  .dashboard-card{ padding-top: 72px; }
  .dashboard-card .icon-bg{
    top: 10px !important;
    width: 46px;
    height: 46px;
    font-size: 1.25rem;
  }
}
/* ==== END FIX ==== */

/* ===== Reset buttons (make red) ===== */
button[id$="ResetBtn"], 
#saleResetBtn, 
#forkliftResetBtn {
  background: #dc3545 !important;
  color: #ffffff !important;
  border: none !important;
  box-shadow: 0 8px 20px rgba(220,53,69,0.22) !important;
}
button[id$="ResetBtn"]:hover, 
#saleResetBtn:hover, 
#forkliftResetBtn:hover {
  background: #bb2d3b !important;
}
button[id$="ResetBtn"]:active, 
#saleResetBtn:active, 
#forkliftResetBtn:active {
  transform: translateY(1px);
}


/* ===== Apply/Update & Reset buttons (same size) ===== */
#saleApplyBtn, #saleResetBtn,
#forkliftUpdateBtn, #forkliftResetBtn,
#applyBtn, #resetBtn,
button[id$="ApplyBtn"], button[id$="UpdateBtn"], button[id$="ResetBtn"]{
  height: 38px !important;
  min-width: 110px;
  padding: 0 18px !important;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  line-height: 1 !important;
  font-size: 0.85rem;
  font-weight: 700;
  border-radius: 999px;
}

</style>
</head>
<body class="h-full">
<div class="main-wrapper">
<div style="max-width: 1400px; margin: 0 auto;">
<!-- Top-right Agent switcher -->
<div style="display:flex; justify-content:flex-end; margin-bottom:1rem;">
<div class="sale-dropdown">
<button class="sale-toggle-btn" type="button">Agent Performance ▾</button>
<div class="sale-dropdown-menu">
<a href="sale-only.html">Sale Team Performance</a>
<a class="active" href="agent-only.html">Agent Performance</a>
<a href="sale-manager.html">Total (Agent &amp; Agent)</a>
</div>
</div>
</div>
<!-- Stats Grid -->
<div class="stats-grid">
<!-- จำนวนสัญญาทั้งหมด -->
<div class="dashboard-card text-center">
<div class="icon-bg"><i class="fas fa-users"></i></div>
<div class="stat-value">22</div>
<div class="stat-title">จำนวนสัญญาทั้งหมด</div>
<div style="margin-top:0.35rem; font-size:0.8rem; width:100%; max-width:210px;">
<div style="display:flex; justify-content:space-between; gap:0.5rem; color:#000000;">
<span>สัญญาทั้งหมด</span>
<span style="font-weight:600; text-align:right; min-width:40px;">22</span>
</div>
<div style="display:flex; justify-content:space-between; gap:0.5rem; margin-top:0.15rem; color:#000000;">
<span>สัญญาใกล้ครบกำหนด</span>
<span style="font-weight:600; text-align:right; min-width:40px;">10</span>
</div>
</div>
</div>
<!-- รถยกที่อยู่ในสัญญาบริการ + Breakdown -->
<div class="dashboard-card text-center">
<div class="icon-bg"><img alt="forklift" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAEZElEQVR4AexWbYhUZRR+zjuruPbBKvojAg2Xsq/NgugDIrZf6UK4s9uWWZkUKRStZbmzH4Wboc3OamlF6lIgwRI0zoy6bUb+aMH6YYltFhRSllhCHwgZ7miz956e9+6dab6cnRmCQrycc897znve9zz3nPfjGvzHzwUA/68MaF/LRvL2c3I4uFnDwSXa21iTvXS0r/URfaVtZrat3HZ+BpZx4IpzssgqiLyL6TP2aW/bxfTzSbcg5TztKxWJfAD+YGUgrITkMeR5OvwGlUbUOtvYTtP7bNxPrpiKA6g9s0M64gMFHIqtJ6iFjHKavFT7W2+lBFSjlFdpeHEDZUVUHECJKQjqEERfp4sw8AZKYPqZD9k+BQm0eXoFr4oBeHPX1LxB6UJxl0aa66V971kYYRn0PtoroqoAyOroz4xykCxA4EFKlkFYBplfaRmqAuAFFIzAPqrNVqB2bG81ZagegOoBLzCwQDfeM6vaMlQPAPKZD8DAmXqH11a/DP3B6z29jFdxAMlpyzXSsiLDRbaXhOI/cf4TZJJ7M1/IlMFB2buhOADIFq7w7RmWmkF9ry3gBcl9jU6ocpOVmTIIyj6UjD1M0l/KSaaRi5A24Ifxx4t0fOXbrvblP7uhzDIYuDqY+VLgksxEBQ1Zp6821+WYFYd9fa72P3yRl6Xk1E+gegpllsGWYI4/yWRiNv4yx7Wv5WSaeSyn74MA3NOHcdQ5htqzT8IeSmWWwQIYmyxyVr+9AWdQT3N2xuYR0OXsCyK9G8Kt11EvSRbAsTyPFPWvyXaVU5QkjlV7Qb3A4BF6HicvgGOOUP4J0aK7QV9bdKmGW5ZqX7DdAviSzj5JHDD2Gt5Pw9sQ915KOylFHgk+pmUfID1QvERew9QnCOQAzHgT5RDXQgaAXT/8mVnG8u1GsvYX9g8y1kID0S8w8RziJPwidytUrqDpAagZgItVbDvkbEpCXQbHozQ+A0fnU/ZwQT8F1RhEmmHLIHItA3aRh7l+GFR2QHAZFGs5b72EYk2GAz6F9/DrRdvZXGQ7kDxp6/cNjC7mIH+/s9eS2GPY3AnILh5Im6U7cYTyZfrZrNhDqQ7uFDvmDwDryTPJ3XDdebzOb5HOeES64kdpg0HyxoMWDVzHAkmhIz5iO6R3ZJybmm25hllqmvBBvSdTzhICt+DzM8OhYvgahaQa4MhtqHHmEtzt5E3StetH9uWQkd5e10MzxbELzyASDFoPu68BaQIwKmsSv1qfDPfsYToxzC8OMr2PabhtjoZbV4P/B7QNM9hD0hkbku7Yt/Ls7uJrCBOPReu15Lmh3zn4RUCinPRz7uvvAcwCxmljK5/qZm9lhriQ8BaE+190E8dvw9gN7+S7ltIzAKwT67MBYhqZ3g+or4MGGiS05wTbBSQrB1ISSixnmlkiczfcwJUc/4TNaIFzCYPJ75OOnfulM7FWQvE3pTNqF1G+S47upblj50fSFf0up6NMpQBAmeP+NbfzH8BkqfobAAD//wBz+t8AAAAGSURBVAMAo+bAUORC9y0AAAAASUVORK5CYII=" style="width:30px;height:30px;display:block;"/></div>
<div class="stat-value">38</div>
<div class="stat-title">รถยกที่อยู่ในสัญญาบริการ</div>
<div class="stat-breakdown">
<div class="stat-breakdown-row">
<span>LPE200</span>
<span>25 คัน</span>
</div>
<div class="stat-breakdown-row">
<span>LHE150</span>
<span>13 คัน</span>
</div>
</div>
</div>
<!-- จำนวนรถที่พร้อมให้บริการ -->
<div class="dashboard-card text-center">
<div class="icon-bg"><img alt="forklift" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAEZElEQVR4AexWbYhUZRR+zjuruPbBKvojAg2Xsq/NgugDIrZf6UK4s9uWWZkUKRStZbmzH4Wboc3OamlF6lIgwRI0zoy6bUb+aMH6YYltFhRSllhCHwgZ7miz956e9+6dab6cnRmCQrycc897znve9zz3nPfjGvzHzwUA/68MaF/LRvL2c3I4uFnDwSXa21iTvXS0r/URfaVtZrat3HZ+BpZx4IpzssgqiLyL6TP2aW/bxfTzSbcg5TztKxWJfAD+YGUgrITkMeR5OvwGlUbUOtvYTtP7bNxPrpiKA6g9s0M64gMFHIqtJ6iFjHKavFT7W2+lBFSjlFdpeHEDZUVUHECJKQjqEERfp4sw8AZKYPqZD9k+BQm0eXoFr4oBeHPX1LxB6UJxl0aa66V971kYYRn0PtoroqoAyOroz4xykCxA4EFKlkFYBplfaRmqAuAFFIzAPqrNVqB2bG81ZagegOoBLzCwQDfeM6vaMlQPAPKZD8DAmXqH11a/DP3B6z29jFdxAMlpyzXSsiLDRbaXhOI/cf4TZJJ7M1/IlMFB2buhOADIFq7w7RmWmkF9ry3gBcl9jU6ocpOVmTIIyj6UjD1M0l/KSaaRi5A24Ifxx4t0fOXbrvblP7uhzDIYuDqY+VLgksxEBQ1Zp6821+WYFYd9fa72P3yRl6Xk1E+gegpllsGWYI4/yWRiNv4yx7Wv5WSaeSyn74MA3NOHcdQ5htqzT8IeSmWWwQIYmyxyVr+9AWdQT3N2xuYR0OXsCyK9G8Kt11EvSRbAsTyPFPWvyXaVU5QkjlV7Qb3A4BF6HicvgGOOUP4J0aK7QV9bdKmGW5ZqX7DdAviSzj5JHDD2Gt5Pw9sQ915KOylFHgk+pmUfID1QvERew9QnCOQAzHgT5RDXQgaAXT/8mVnG8u1GsvYX9g8y1kID0S8w8RziJPwidytUrqDpAagZgItVbDvkbEpCXQbHozQ+A0fnU/ZwQT8F1RhEmmHLIHItA3aRh7l+GFR2QHAZFGs5b72EYk2GAz6F9/DrRdvZXGQ7kDxp6/cNjC7mIH+/s9eS2GPY3AnILh5Im6U7cYTyZfrZrNhDqQ7uFDvmDwDryTPJ3XDdebzOb5HOeES64kdpg0HyxoMWDVzHAkmhIz5iO6R3ZJybmm25hllqmvBBvSdTzhICt+DzM8OhYvgahaQa4MhtqHHmEtzt5E3StetH9uWQkd5e10MzxbELzyASDFoPu68BaQIwKmsSv1qfDPfsYToxzC8OMr2PabhtjoZbV4P/B7QNM9hD0hkbku7Yt/Ls7uJrCBOPReu15Lmh3zn4RUCinPRz7uvvAcwCxmljK5/qZm9lhriQ8BaE+190E8dvw9gN7+S7ltIzAKwT67MBYhqZ3g+or4MGGiS05wTbBSQrB1ISSixnmlkiczfcwJUc/4TNaIFzCYPJ75OOnfulM7FWQvE3pTNqF1G+S47upblj50fSFf0up6NMpQBAmeP+NbfzH8BkqfobAAD//wBz+t8AAAAGSURBVAMAo+bAUORC9y0AAAAASUVORK5CYII=" style="width:30px; height:30px; object-fit:contain;"/></div>
<div class="stat-value">45</div>
<div class="stat-title">จำนวนรถที่พร้อมให้บริการ</div>
</div>
<!-- บัญชีทั้งหมด -->
<div class="dashboard-card text-center">
<div class="icon-bg"><i class="fas fa-users"></i></div>
<div class="stat-value">155</div>
<div class="stat-title">บัญชีทั้งหมด</div>
<div class="stat-breakdown">
<div class="stat-breakdown-row">
<span>บัญชีลีด</span>
<span>0</span>
</div>
<div class="stat-breakdown-row">
<span>บัญชีบุคคลธรรมดา</span>
<span>100</span>
</div>
</div>
</div>
</div>
<!-- สรุปข้อมูลการเช่า : Compare Agent + Date Range -->
<div class="card" id="monthly-sale-summary" style="max-width: 1400px; margin: 0 auto; background-color: #FFFFFF;">
<h2 class="card-title">สรุปข้อมูลการเช่า (ใบเสนอราคาเทียบสัญญาบริการ)</h2>
<p style="font-size: 0.85rem; color: var(--muted-text); margin-top: -0.25rem; margin-bottom: 0.9rem;">
    เปรียบเทียบผลงานของ Agent ตามช่วงวันที่ที่เลือก (รวมจำนวนใบเสนอราคา และจำนวนสัญญาบริการ)
  </p>
<!-- Filters -->
<div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end; margin-bottom:1rem;">
<div style="min-width:220px;">
<div style="font-size:0.78rem; color:var(--muted-text); margin-bottom:0.35rem;">เลือกช่วงวันเริ่มต้น</div>
<input id="saleStartDate" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="min-width:220px;">
<div style="font-size:0.78rem; color:var(--muted-text); margin-bottom:0.35rem;">เลือกช่วงวันสิ้นสุด</div>
<input id="saleEndDate" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="min-width:260px; flex:1;">
<div style="font-size:0.78rem; color:var(--muted-text); margin-bottom:0.35rem;">เลือก Agent (เลือกได้หลายคน)</div>
<!-- Hidden native select (kept for logic) -->
<select id="saleMultiSelect" multiple="" style="display:none;"></select>
<!-- Dropdown checkbox multi-select -->
<div class="mdrop" id="saleDropdown">
<button aria-expanded="false" aria-haspopup="listbox" class="mdrop-btn" id="saleDropdownBtn" type="button">
          เลือก Agent
          <span class="mdrop-caret">▾</span>
</button>
<div aria-multiselectable="true" class="mdrop-panel" id="saleDropdownPanel" role="listbox">
<div class="mdrop-actions">
<button class="mdrop-action" id="saleSelectAll" type="button">เลือกทั้งหมด</button>
<button class="mdrop-action" id="saleClearAll" type="button">ล้าง</button>
</div>
<div class="mdrop-list" id="saleDropdownList"></div>
</div>
</div>
</div>
<div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
<button id="saleApplyBtn" style="padding:0.6rem 1rem; border-radius:999px; border:none; background:var(--primary-color); color:#fff; font-weight:700; cursor:pointer; box-shadow: 0 4px 10px rgba(31,111,178,0.35);" type="button">
        อัปเดตกกราฟ
      </button>
<button id="saleResetBtn" style="padding:0.6rem 1rem; border-radius:999px; border:1px solid #e5e7eb; background:#fff; color:#111827; font-weight:700; cursor:pointer;" type="button">
        รีเซ็ต
      </button>
</div>
</div>
<!-- Summary chips -->
<div id="saleSummaryChips" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 0.75rem; margin-bottom: 1rem;">
</div>
<!-- Chart -->
<div class="chart-card" style="background:#ffffff; border:1px solid #e5edf8;">
<div class="chart-title">กราฟเปรียบเทียบผลงาน Agent (ตามช่วงวันที่ที่เลือก)</div>
<div class="chart-subtitle">แสดงยอดรวมในช่วงวันเริ่มต้น–สิ้นสุด (จำนวนใบเสนอราคา และจำนวนสัญญาบริการ) สำหรับ Agent ที่เลือก</div>
<div style="position:relative; min-height:260px;">
<canvas id="saleCompareChart"></canvas>
</div>
</div>
<!-- Agent table (optional) -->
<div style="margin-top:1rem;">
<div style="display:flex; justify-content:space-between; align-items:center; gap:0.75rem; margin-bottom:0.5rem;">
<div style="font-size:0.95rem; font-weight:600; color:var(--dark-text);">สรุป Agent (ตาราง)</div>
<div id="saleTableRange" style="font-size:0.78rem; color:var(--muted-text);"></div>
</div>
<div style="overflow-x:auto;">
<table class="simple-table" id="saleSummaryTable">
<thead>
<tr>
<th style="text-align:center; width:60px;">ลำดับ</th>
<th>Agent</th>
<th style="text-align:right;">จำนวนใบเสนอราคา</th>
<th style="text-align:right;">จำนวนสัญญาบริการ</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
<!-- Charts -->
<div class="card" id="monthly-forklift-summary" style="max-width: 1400px; margin: 0 auto; margin-top: 15px;">
<h2 class="card-title">สรุปข้อมูลการเช่า (รถยกในใบเสนอราคาเทียบรถยกในสัญญาบริการ)</h2>
<p style="font-size: 0.85rem; color: var(--muted-text); margin-top: -0.25rem; margin-bottom: 0.9rem;">
    เปรียบเทียบจำนวนรถยกตามช่วงวันที่ที่เลือก (รวมจำนวนรถยกในใบเสนอราคา และจำนวนรถยกในสัญญาบริการ) — อ้างอิงจาก “สรุปช่วงวันที่เลือก (รวมทีม)”
  </p>
<!-- Filters (Forklift summary) -->
<div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end; margin-bottom:1rem;">
<div style="min-width:220px;">
<div style="font-size:0.78rem; color:var(--muted-text); margin-bottom:0.35rem;">เลือกช่วงวันเริ่มต้น</div>
<input id="forkliftStartDate" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="min-width:220px;">
<div style="font-size:0.78rem; color:var(--muted-text); margin-bottom:0.35rem;">เลือกช่วงวันสิ้นสุด</div>
<input id="forkliftEndDate" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="min-width:260px; flex:1;">
<div style="font-size:0.78rem; color:var(--muted-text); margin-bottom:0.35rem;">เลือก Agent (เลือกได้หลายคน)</div>
<!-- Hidden native select (kept for logic) -->
<select id="forkliftMultiSelect" multiple="" style="display:none;"></select>
<!-- Dropdown checkbox multi-select -->
<div class="mdrop" id="forkliftDropdown">
<button aria-expanded="false" aria-haspopup="listbox" class="mdrop-btn" id="forkliftDropdownBtn" type="button">
        เลือก Agent
        <span class="mdrop-caret">▾</span>
</button>
<div aria-multiselectable="true" class="mdrop-panel" id="forkliftDropdownPanel" role="listbox">
<div class="mdrop-actions">
<button class="mdrop-action" id="forkliftSelectAllBtn" type="button">เลือกทั้งหมด</button>
<button class="mdrop-action" id="forkliftClearBtn" type="button">ล้าง</button>
</div>
<div class="mdrop-list" id="forkliftDropdownList"></div>
</div>
</div>
</div>
<div style="display:flex; gap:0.5rem; align-items:flex-end;">
<button class="card-link-btn" id="forkliftUpdateBtn" type="button">อัปเดต</button>
<button class="mdrop-action" id="forkliftResetBtn" style="padding:0.45rem 1.1rem; height:38px;" type="button">รีเซ็ต</button>
</div>
</div>
<!-- Summary chips -->
<div id="forkliftSummaryChips" style="display:grid; grid-template-columns:repeat(4, minmax(0, 1fr)); gap:0.75rem; margin-bottom: 1rem;"></div>
<!-- Chart: Compare forklift in quotation vs contract -->
<div class="chart-card" style="background:#ffffff; border:1px solid #e5edf8; margin-top:1rem;">
<div class="chart-title">กราฟเปรียบเทียบจำนวนรถยก (ใบเสนอราคา vs สัญญาบริการ)</div>
<div class="chart-subtitle">รวมตามช่วงวันที่ที่เลือก สำหรับ Sale ที่เลือก</div>
<div style="position:relative; min-height:260px;">
<div class="chart-canvas-wrap"><canvas id="forkliftCompareChart"></canvas></div>
<div id="forkliftCompareFallback" style="margin-top:0.75rem;"></div>
</div>
</div>
<!-- Table -->
<div style="overflow:auto; border:1px solid #e5edf8; border-radius: 12px;">
<table class="simple-table" style="min-width:760px;">
<thead>
<tr>
<th style="text-align:center; width:60px;">ลำดับ</th>
<th>Agent</th>
<th style="text-align:right;">จำนวนรถยกในใบเสนอราคา</th>
<th style="text-align:right;">จำนวนรถยกในสัญญาบริการ</th>
<th style="text-align:right;">อัตราสำเร็จ (%)</th>
</tr>
</thead>
<tbody id="forkliftSummaryTbody"></tbody>
</table>
</div>
</div>
<div class="card" style="max-width: 1400px; margin: 0 auto; margin-top: 15px;">
<h2 class="card-title">กราฟสรุปรุ่นรถยกที่ทำสัญญา และจำนวนรถยกของลูกค้าที่ทำสัญญากับ Agent</h2>
<p style="font-size:0.8rem; color:var(--muted-text); margin-top:-0.2rem; margin-bottom:0.6rem;">
            มองภาพรวม “รุ่นรถยกที่ทำสัญญา” และ “จำนวนรถยกของลูกค้าที่ทำสัญญากับ Agent” (ตัวอย่างข้อมูลจำลอง)</p>
<div class="chart-grid">
<!-- ซ้าย: กราฟสรุปจำนวนสัญญา -->
<div class="chart-card">
<div class="card-title" style="font-size:0.9rem;">กราฟสรุปรุ่นรถยกที่ทำสัญญา</div>
<div class="chart-filters">
<div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
<div style="display:flex; flex-direction:column; gap:0.25rem;">
<div style="font-size:0.75rem; color:var(--muted-text);">ช่วงวันเริ่ม (Start)</div>
<input id="modelStartDate" style="padding:0.45rem 0.7rem; border-radius:0.6rem; border:1px solid #e5e7eb; width:170px; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="display:flex; flex-direction:column; gap:0.25rem;">
<div style="font-size:0.75rem; color:var(--muted-text);">ช่วงวันสิ้นสุด (End)</div>
<input id="modelEndDate" style="padding:0.45rem 0.7rem; border-radius:0.6rem; border:1px solid #e5e7eb; width:170px; font-family:'Prompt',sans-serif;" type="date"/>
</div>
</div>
</div>
<div style="position:relative; min-height:220px; margin-top: 55px;">
<canvas id="modelHoursChart"></canvas>
</div>
</div>
<!-- ขวา: กราฟสรุปการชำระเงินแพ็ค/ชม. (แท่งสีส้ม) -->
<div class="chart-card">
<div class="card-title" style="font-size:0.9rem;">กราฟจำนวนรถยกของลูกค้าที่ทำสัญญากับ Agent</div>
<div class="chart-subtitle" style="margin-top:-0.35rem;">
      แสดงจำนวนรถยกที่ทำสัญญา แยกตาม Agent (ตัวอย่างข้อมูลจำลอง) ตามช่วงวันที่และ Agent ที่เลือก
    </div>
<div class="chart-filters" style="margin-top: 8px;">
<div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
<div style="display:flex; flex-direction:column; gap:0.25rem;">
<div style="font-size:0.75rem; color:var(--muted-text);">ช่วงวันเริ่ม (Start)</div>
<input id="saleForkStartDate" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; width:170px; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="display:flex; flex-direction:column; gap:0.25rem;">
<div style="font-size:0.75rem; color:var(--muted-text);">ช่วงวันสิ้นสุด (End)</div>
<input id="saleForkEndDate" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; width:170px; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="display:flex; flex-direction:column; gap:0.25rem; min-width:240px; flex:1;">
<div style="font-size:0.75rem; color:var(--muted-text);">Agent</div>
<select id="saleForkAgentFilter" style="padding:0.45rem 0.7rem; border-radius:0.6rem; border:1px solid #e5e7eb; width:100%; font-family:'Prompt',sans-serif;">
<option selected="" value="__use_main__">ตาม Agent ที่เลือกด้านบน</option>
<option value="ALL">ทุก Agent</option>
</select>
</div>
</div>
</div>
<div style="position:relative; min-height:220px; margin-top: 30px;">
<canvas id="saleForkliftChart"></canvas>
</div>
</div>
</div>
</div>
<!-- Active contracts + Pending -->
<div class="content-grid" style="max-width: 1400px; margin: 0 auto; margin-top: 15px;">
<!-- สัญญาเช่าที่ใช้งานอยู่ -->
<div class="card">
<div class="card-header-row">
<h2 class="card-title">สัญญาเช่าที่ใช้งานอยู่</h2>
<button class="card-link-btn" type="button">สัญญาเช่าทั้งหมด</button>
</div>
<div class="scroll-list">
<div class="contract-item">
<div class="contract-header">
<div class="contract-id">CT250010 (Agent - Agent A)</div>
<span class="status-badge status-active">Active</span>
</div>
<div class="contract-amount">฿85,000/งวด</div>
<div class="contract-details">
<div>
<span>บริษัท โลจิสติกส์ โปร จำกัด</span>
<ul class="contract-meta">
<li>Model LHE จำนวน 1 คัน</li>
<li>Model LPE จำนวน 2 คัน</li>
</ul>
</div>
<span>สิ้นสุด: 15 มี.ค. 2567</span>
</div>
</div>
<div class="contract-item">
<div class="contract-header">
<div class="contract-id">CT250011 (Agent - Agent B)</div>
<span class="status-badge status-active">Active</span>
</div>
<div class="contract-amount">฿125,000/งวด</div>
<div class="contract-details">
<div>
<span>ห้างหุ้นส่วน ไทยคลัง</span>
<ul class="contract-meta">
<li>Model LHE จำนวน 2 คัน</li>
<li>Model LPE จำนวน 3 คัน</li>
</ul>
</div>
<span>สิ้นสุด: 28 ก.พ. 2567</span>
</div>
</div>
<div class="contract-item">
<div class="contract-header">
<div class="contract-id">CT250012 (Agent - Agent A)</div>
<span class="status-badge status-active">Active</span>
</div>
<div class="contract-amount">฿45,000/งวด</div>
<div class="contract-details">
<div>
<span>บริษัท แมนูแฟคเจอริ่ง</span>
<ul class="contract-meta">
<li>Model LHE จำนวน 1 คัน</li>
<li>Model LPE จำนวน 1 คัน</li>
</ul>
</div>
<span>เริ่ม: 25 ม.ค. 2567</span>
</div>
</div>
<div class="contract-item">
<div class="contract-header">
<div class="contract-id">CT250013 (Agent - Agent C)</div>
<span class="status-badge status-active">Active</span>
</div>
<div class="contract-amount">฿60,000/งวด</div>
<div class="contract-details">
<div>
<span>บริษัท คลังสินค้าไทย</span>
<ul class="contract-meta">
<li>Model LHE จำนวน 1 คัน</li>
<li>Model LPE จำนวน 1 คัน</li>
</ul>
</div>
<span>สิ้นสุด: 30 เม.ย. 2567</span>
</div>
</div>
<div class="contract-item">
<div class="contract-header">
<div class="contract-id">CT250014 (Agent - Agent D)</div>
<span class="status-badge status-active">Active</span>
</div>
<div class="contract-amount">฿90,000/งวด</div>
<div class="contract-details">
<div>
<span>บริษัท ซัพพลายเชน โซลูชั่น</span>
<ul class="contract-meta">
<li>Model LHE จำนวน 2 คัน</li>
<li>Model LPE จำนวน 1 คัน</li>
</ul>
</div>
<span>สิ้นสุด: 20 มี.ค. 2567</span>
</div>
</div>
</div>
</div>
<!-- รออนุมัติสัญญาบริการ -->
<div class="card">
<div class="card-header-row">
<h2 class="card-title">รออนุมัติสัญญาบริการ</h2>
<button class="card-link-btn" type="button">สัญญาบริการทั้งหมด</button>
</div>
<div class="scroll-list">
<div class="quotation-item">
<div class="quotation-info">
<h4>CT250030 (Agent - Agent A)</h4>
<p>บริษัท เทรดดิ้ง เซ็นเตอร์</p>
<ul class="quotation-meta">
<li>Model LHE จำนวน 1 คัน</li>
<li>Model LPE จำนวน 1 คัน</li>
<li>ระยะเวลาของสัญญา 12 เดือน</li>
</ul>
</div>
<div class="quotation-value">
<p class="quotation-amount">฿50,000/งวด</p>
<span class="status-badge status-pending">Pending</span>
</div>
</div>
<div class="quotation-item">
<div class="quotation-info">
<h4>CT250031  (Agent - Agent D)</h4>
<p>ห้างหุ้นส่วน ซัพพลาย</p>
<ul class="quotation-meta">
<li>Model LHE จำนวน 1 คัน</li>
<li>ระยะเวลาของสัญญา 6 เดือน</li>
</ul>
</div>
<div class="quotation-value">
<p class="quotation-amount">฿22,000/งวด</p>
<span class="status-badge status-pending">Pending</span>
</div>
</div>
<div class="quotation-item">
<div class="quotation-info">
<h4>CT250032  (Agent - Agent A)</h4>
<p>บริษัท เวร์เฮ้าส์ โซลูชั่น</p>
<ul class="quotation-meta">
<li>Model LHE จำนวน 2 คัน</li>
<li>Model LPE จำนวน 4 คัน</li>
<li>ระยะเวลาของสัญญา 24 เดือน</li>
</ul>
</div>
<div class="quotation-value">
<p class="quotation-amount">฿140,000/งวด</p>
<span class="status-badge status-pending">Pending</span>
</div>
</div>
<div class="quotation-item">
<div class="quotation-info">
<h4>CT250033 (Agent - Agent E)</h4>
<p>บริษัท พาร์ท ดิสทริบิวชั่น</p>
<ul class="quotation-meta">
<li>Model LHE จำนวน 1 คัน</li>
<li>Model LPE จำนวน 2 คัน</li>
<li>ระยะเวลาของสัญญา 3 เดือน</li>
</ul>
</div>
<div class="quotation-value">
<p class="quotation-amount">฿72,000/งวด</p>
<span class="status-badge status-pending">Pending</span>
</div>
</div>
<div class="quotation-item">
<div class="quotation-info">
<h4>CT250034 (Agent - Agent C)</h4>
<p>ห้างหุ้นส่วน คอนสตรัคชั่น</p>
<ul class="quotation-meta">
<li>Model LHE จำนวน 1 คัน</li>
<li>Model LPE จำนวน 1 คัน</li>
<li>ระยะเวลาของสัญญา 6 เดือน</li>
</ul>
</div>
<div class="quotation-value">
<p class="quotation-amount">฿35,000/งวด</p>
<span class="status-badge status-pending">Pending</span>
</div>
</div>
</div>
</div>
</div>
<!-- Bottom Grid: Payment + Fleet -->
<div class="content-grid" style="max-width: 1400px; margin: 0 auto; ">
<!-- Payment schedule -->
<div class="card">
<h2 class="card-title">กำหนดการรับชำระค่าเช่า</h2>
<div class="payment-timeline scroll-list">
<div class="timeline-item">
<div class="timeline-dot"></div>
<div class="timeline-content">
<h4>CT250010 - งวด 1/6</h4>
<div>Agent - Agent A</div>
<p>บริษัท โลจิสติกส์ โปร จำกัด</p>
<p style="color: #f97316;">⏱ ครบกำหนด - 5 ม.ค. 2567</p>
<div class="timeline-amount">฿85,000</div>
</div>
</div>
<div class="timeline-item">
<div class="timeline-dot"></div>
<div class="timeline-content">
<h4>CT250011 - งวด 3/8</h4>
<div>Agent - Agent A</div>
<p>ห้างหุ้นส่วน ไทยคลัง</p>
<p style="color: #f97316;">⏱ ครบกำหนด - 28 ม.ค. 2567</p>
<div class="timeline-amount">฿125,000</div>
</div>
</div>
<div class="timeline-item">
<div class="timeline-dot"></div>
<div class="timeline-content">
<h4>CT250012 - งวด 2/4</h4>
<div>Agent - Agent A</div>
<p>บริษัท แมนูแฟคเจอริ่ง</p>
<p style="color: #f97316;">⏱ ครบกำหนด - 30 ม.ค. 2567</p>
<div class="timeline-amount">฿45,000</div>
</div>
</div>
<div class="timeline-item">
<div class="timeline-dot"></div>
<div class="timeline-content">
<h4>CT250013 - งวด 6/6</h4>
<div>Agent - Agent A</div>
<p>บริษัท คลังสินค้าไทย</p>
<p style="color: #f97316;">⏱ ครบกำหนด - 5 ก.พ. 2567</p>
<div class="timeline-amount">฿60,000</div>
</div>
</div>
<div class="timeline-item">
<div class="timeline-dot"></div>
<div class="timeline-content">
<h4>CT250014 - งวด 1/4</h4>
<div>Agent - Agent A</div>
<p>บริษัท ซัพพลายเชน โซลูชั่น</p>
<p style="color: #f97316;">⏱ ครบกำหนด - 10 ก.พ. 2567</p>
<div class="timeline-amount">฿90,000</div>
</div>
</div>
</div>
</div> </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

document.addEventListener('DOMContentLoaded', () => {
  const ensureChartJs = (done) => {
    if (window.Chart) return done(true);
    const sc = document.createElement('script');
    sc.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    sc.onload = () => done(true);
    sc.onerror = () => done(false);
    document.head.appendChild(sc);
  };

  ensureChartJs(() => {

        const hasChart = typeof window.Chart !== 'undefined';

      // ========= Helpers =========
      const pad2 = (n) => String(n).padStart(2, '0');
      const toYMD = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      const safeDate = (v) => {
        if (!v) return null;
        const d = new Date(v);
        return isNaN(d.getTime()) ? null : d;
      };

      const monthKey = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
      const monthRangeKeys = (startDateStr, endDateStr) => {
        const s = safeDate(startDateStr);
        const e = safeDate(endDateStr);
        if (!s || !e) return [];
        const start = new Date(Math.min(s.getTime(), e.getTime()));
        const end = new Date(Math.max(s.getTime(), e.getTime()));
        const cur = new Date(start.getFullYear(), start.getMonth(), 1);
        const last = new Date(end.getFullYear(), end.getMonth(), 1);
        const keys = [];
        while (cur <= last) {
          keys.push(`${cur.getFullYear()}-${pad2(cur.getMonth()+1)}`);
          cur.setMonth(cur.getMonth() + 1);
        }
        return keys;
      };

      const formatRange = (startDateStr, endDateStr) => {
        const s = safeDate(startDateStr);
        const e = safeDate(endDateStr);
        if (!s || !e) return '';
        const ss = new Date(Math.min(s.getTime(), e.getTime()));
        const ee = new Date(Math.max(s.getTime(), e.getTime()));
        const sTxt = `${pad2(ss.getDate())}/${pad2(ss.getMonth()+1)}/${ss.getFullYear()}`;
        const eTxt = `${pad2(ee.getDate())}/${pad2(ee.getMonth()+1)}/${ee.getFullYear()}`;
        return `${sTxt} - ${eTxt}`;
      };

      // ========= Mock data (stable) =========
      // saleMonthly: { saleName: { 'YYYY-MM': { c: quotations, u: services } } }
      const sales = ['Agent A','Agent B','Agent C','Agent D','Agent E'];
      const saleMonthly = (() => {
        const obj = {};
        sales.forEach((s) => (obj[s] = {}));
        const years = [2024, 2025];
        years.forEach((y) => {
          for (let m = 1; m <= 12; m++) {
            const mk = `${y}-${pad2(m)}`;
            sales.forEach((s, si) => {
              // Deterministic pattern (no random)
              const base = ((y - 2023) * 7 + m * 3 + si * 5) % 12;
              const services = Math.max(1, 3 + (base % 7));          // 3..9
              const quotations = Math.max(services, services + (base % 4) + 1); // >= services
              obj[s][mk] = { c: quotations, u: services };
            });
          }
        });
        return obj;
      })();

      // transactions for forklift-by-sale-by-model chart
      const forkliftModels = ['LHE','LPE','RRE'];
      const saleForkTx = (() => {
        const tx = [];
        const years = [2024, 2025];
        const days = [3, 12, 24];
        years.forEach((y, yi) => {
          for (let m = 1; m <= 12; m++) {
            sales.forEach((sale, si) => {
              forkliftModels.forEach((model, mi) => {
                const base = (yi * 11 + m * 3 + si * 4 + mi * 5) % 9 + 1;
                const boost = model === 'LHE' ? 2 : 0;
                const qty = base + boost; // 3..12-ish
                days.forEach((d, di) => {
                  const portion = di === 0 ? 0.40 : di === 1 ? 0.35 : 0.25;
                  const q = Math.max(1, Math.round(qty * portion));
                  tx.push({ date: `${y}-${pad2(m)}-${pad2(d)}`, sale, model, qty: q });
                });
              });
            });
          }
        });
        return tx;
      })();



      // Quotation forklift transactions (mock data) - used for forklift quotation vs service success
      const quoteForkTx = (() => {
        const tx = [];
        const years = [2024, 2025];
        const days = [2, 10, 22];
        years.forEach((y, yi) => {
          for (let m = 1; m <= 12; m++) {
            sales.forEach((sale, si) => {
              forkliftModels.forEach((model, mi) => {
                const base = (yi * 13 + m * 4 + si * 5 + mi * 6) % 10 + 3;
                const boost = model === 'LHE' ? 3 : 0;
                const qty = base + boost; // 6..16-ish (usually >= contracts)
                days.forEach((d, di) => {
                  const portion = di === 0 ? 0.42 : di === 1 ? 0.33 : 0.25;
                  const q = Math.max(1, Math.round(qty * portion));
                  tx.push({ date: `${y}-${pad2(m)}-${pad2(d)}`, sale, model, qty: q });
                });
              });
            });
          }
        });
        return tx;
      })();

    // ========= Section 1: Agent Compare (Summary) =========
      const startEl = document.getElementById('saleStartDate');
      const endEl = document.getElementById('saleEndDate');
      const applyBtn = document.getElementById('saleApplyBtn');
      const resetBtn = document.getElementById('saleResetBtn');
      const saleCanvas = document.getElementById('saleCompareChart');
      const chipsEl = document.getElementById('saleSummaryChips');
      const rangeEl = document.getElementById('saleTableRange');
      const tableBody = document.querySelector('#saleSummaryTable tbody');

      // hidden select used for logic
      const saleSelect = document.getElementById('saleMultiSelect');

      // checkbox dropdown UI
      const saleMultiDropdown = document.getElementById('saleDropdown');
      const saleDropdownBtn = document.getElementById('saleDropdownBtn');
      const saleDropdownPanel = document.getElementById('saleDropdownPanel');
      const saleDropdownList = document.getElementById('saleDropdownList');
      const saleSelectAllBtn = document.getElementById('saleSelectAll');
      const saleClearAllBtn = document.getElementById('saleClearAll');

      function populateHiddenAgentSelect() {
        if (!saleSelect) return;
        saleSelect.innerHTML = '';
        Object.keys(saleMonthly).forEach((name) => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          opt.selected = true; // default: all selected
          saleSelect.appendChild(opt);
        });
      }

      function getSelectedAgents() {
        if (!saleSelect) return Object.keys(saleMonthly);
        const vals = Array.from(saleSelect.selectedOptions || []).map(o => o.value).filter(Boolean);
        return vals.length ? vals : Object.keys(saleMonthly);
      }

      function updateAgentDropdownLabel() {
        if (!saleDropdownBtn || !saleSelect) return;
        const total = saleSelect.options.length;
        const selected = Array.from(saleSelect.options).filter(o => o.selected).length;
        const effective = selected === 0 ? total : selected;
        const label = (effective === total) ? 'เลือก Agent (ทั้งหมด)' : `เลือก Agent (${effective} รายการ)`;
        saleDropdownBtn.innerHTML = `${label} <span class="mdrop-caret">▾</span>`;
      }

      function initAgentDropdown() {
        if (!saleMultiDropdown || !saleDropdownBtn || !saleDropdownPanel || !saleDropdownList || !saleSelect) return;

        saleDropdownList.innerHTML = '';
        Array.from(saleSelect.options).forEach((opt) => {
          const row = document.createElement('label');
          row.className = 'mdrop-item';

          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = !!opt.selected;
          cb.dataset.value = opt.value;

          const txt = document.createElement('span');
          txt.textContent = opt.textContent;

          cb.addEventListener('change', () => {
            const o = Array.from(saleSelect.options).find(x => x.value === cb.dataset.value);
            if (o) o.selected = cb.checked;
            updateAgentDropdownLabel();
            updateAgentCompare();
            updateAgentForkChart(); // keep charts synced
          });

          row.appendChild(cb);
          row.appendChild(txt);
          saleDropdownList.appendChild(row);
        });

        updateAgentDropdownLabel();

        const close = () => {
          saleMultiDropdown.classList.remove('open');
          saleDropdownBtn.setAttribute('aria-expanded', 'false');
        };
        const open = () => {
          saleMultiDropdown.classList.add('open');
          saleDropdownBtn.setAttribute('aria-expanded', 'true');
        };

        saleDropdownBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (saleMultiDropdown.classList.contains('open')) close(); else open();
        });
        saleDropdownPanel.addEventListener('click', (e) => e.stopPropagation());
        document.addEventListener('click', () => close());
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });

        if (saleSelectAllBtn) {
          saleSelectAllBtn.addEventListener('click', () => {
            Array.from(saleSelect.options).forEach(o => o.selected = true);
            Array.from(saleDropdownList.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = true);
            updateAgentDropdownLabel();
            updateAgentCompare();
            updateAgentForkChart();
          });
        }
        if (saleClearAllBtn) {
          saleClearAllBtn.addEventListener('click', () => {
            Array.from(saleSelect.options).forEach(o => o.selected = false);
            Array.from(saleDropdownList.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = false);
            updateAgentDropdownLabel();
            updateAgentCompare();
            updateAgentForkChart();
          });
        }
      }

      function sumByAgent(saleName, keys) {
        let quotations = 0;
        let services = 0;
        const map = saleMonthly[saleName] || {};
        keys.forEach((k) => {
          const row = map[k];
          if (!row) return;
          const c = row.c || 0;
          const u = row.u || 0;
          quotations += Math.max(c, u);
          services += Math.min(c, u);
        });
        return { sale: saleName, quotations, services };
      }

      function renderChips(rows) {
        if (!chipsEl) return;
        const totalQ = rows.reduce((a, r) => a + r.quotations, 0);
        const totalS = rows.reduce((a, r) => a + r.services, 0);
        const avgQ = rows.length ? (totalQ / rows.length) : 0;
        const avgS = rows.length ? (totalS / rows.length) : 0;
        const successRate = totalQ ? ((totalS / totalQ) * 100) : 0;
        const top = rows.slice().sort((a, b) => b.quotations - a.quotations)[0];
        const topText = top ? `${top.sale} 🏆 Top • ${top.quotations} ใบเสนอราคา / ${top.services} สัญญาบริการ` : '-';

        chipsEl.innerHTML = `
          <div style="padding: 0.75rem 1rem; background:#f9fbff; border-radius:10px; border:1px solid #e5edf8;">
            <div style="font-size: 0.75rem; color:#64748b; margin-bottom:0.25rem;">สรุปใบเสนอราคาและสัญญาบริการ</div>
            <div style="font-size:1rem; font-weight:700; color:var(--primary-color);">${totalQ} ใบเสนอราคา / ${totalS} สัญญาบริการ</div>
          </div>
          <div style="padding: 0.75rem 1rem; background:#fff7e6; border-radius:10px; border:1px solid #fed7aa;">
            <div style="font-size: 0.75rem; color:#92400e; margin-bottom:0.25rem;">Top Agent (ตามใบเสนอราคา)</div>
            <div style="font-size:1rem; font-weight:700; color:#b45309;">${topText}</div>
          </div>
          <div style="padding: 0.75rem 1rem; background:#e0fcef; border-radius:10px; border:1px solid #bbf7d0;">
            <div style="font-size: 0.75rem; color:#047857; margin-bottom:0.25rem;">อัตราการทำสัญญาบริการสำเร็จ</div>
            <div style="font-size:1rem; font-weight:700; color:#047857;">${successRate.toFixed(1)}%</div>
            <div style="font-size:0.78rem; font-weight:600; color:#047857; margin-top:0.15rem; opacity:0.95;">ใบเสนอราคา ${totalQ} / สัญญาบริการ ${totalS}</div>
          </div>
        `;
      }

      function renderTable(rows, rangeText) {
        if (rangeEl) rangeEl.textContent = rangeText ? `ช่วงวันที่: ${rangeText}` : '';
        if (!tableBody) return;
        const sorted = rows.slice().sort((a, b) => b.quotations - a.quotations);
        tableBody.innerHTML = sorted.map((r, i) => `
          <tr>
            <td style="text-align:center;">${i + 1}</td>
            <td>${r.sale}${i === 0 ? ' 🏆' : ''}</td>
            <td style="text-align:right;">${r.quotations}</td>
            <td style="text-align:right;">${r.services}</td>
          </tr>
        `).join('');
      }

      let saleChart = null;
      if (saleCanvas && hasChart) {
        saleChart = new Chart(saleCanvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: [],
            datasets: [
              { label: 'จำนวนใบเสนอราคา', data: [], backgroundColor: 'rgba(31, 111, 178, 0.85)', borderWidth: 0 },
              { label: 'จำนวนสัญญาบริการ', data: [], backgroundColor: 'rgba(255, 122, 26, 0.85)', borderWidth: 0 },
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' }, tooltip: { enabled: true } },
            scales: {
              x: { grid: { display: false } },
              y: { beginAtZero: true, ticks: { precision: 0 } }
            }
          }
        });
      }

      function updateAgentCompare() {
        if (!startEl || !endEl) return;

        const today = new Date();
        const yyyy = today.getFullYear();
        const defaultStart = `${yyyy}-01-01`;
        const defaultEnd = toYMD(today);

        const startVal = startEl.value || defaultStart;
        const endVal = endEl.value || defaultEnd;
        const keys = monthRangeKeys(startVal, endVal);
        const selected = getSelectedAgents();

        const rows = selected.map(s => sumByAgent(s, keys));
        renderChips(rows);
        renderTable(rows, formatRange(startVal, endVal));

        if (saleChart) {
          saleChart.data.labels = rows.map(r => r.sale);
          saleChart.data.datasets[0].data = rows.map(r => r.quotations);
          saleChart.data.datasets[1].data = rows.map(r => r.services);
          saleChart.update();
        }
      }

      // Defaults for summary date range
      (function initSummaryDateDefaults(){
        if (!startEl || !endEl) return;
        const today = new Date();
        const yyyy = today.getFullYear();
        if (!startEl.value) startEl.value = `${yyyy}-01-01`;
        if (!endEl.value) endEl.value = toYMD(today);
      })();

      // ========= Section 2: Model chart (month/year) =========
      const modelCanvas = document.getElementById('modelHoursChart');
      const modelStartEl = document.getElementById('modelStartDate');
      const modelEndEl = document.getElementById('modelEndDate'); 

      function getModelSeriesByRange(startDate, endDate) {
        const sTime = Math.min(startDate.getTime(), endDate.getTime());
        const eTime = Math.max(startDate.getTime(), endDate.getTime());
        const sum = { LHE: 0, LPE: 0, RRE: 0 };

        // derive from transactions (same dataset with Agent chart) to keep preview stable
        saleForkTx.forEach((t) => {
          const d = new Date(t.date);
          const tt = d.getTime();
          if (tt < sTime || tt > eTime) return;
          if (sum[t.model] != null) sum[t.model] += (+t.qty || 0);
        });

        return { labels: ['LHE','LPE','RRE'], values: [sum.LHE, sum.LPE, sum.RRE] };
      }

      let modelChart = null;
      if (modelCanvas && hasChart) {
        modelChart = new Chart(modelCanvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['LHE','LPE','RRE'],
            datasets: [{
              label: 'จำนวนรถยกที่ทำสัญญา (คัน)',
              data: [0,0,0],
              borderWidth: 0,
              backgroundColor: 'rgba(31, 111, 178, 0.85)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { enabled: true } },
            scales: { x: { grid: { display: false } }, y: { beginAtZero: true, ticks: { precision: 0 } } }
          }
        });
      }

      function updateModelChart() {
        if (!modelChart) return;

        // Default: first day of current month -> today
        const today = new Date();
        const defaultStart = new Date(today.getFullYear(), today.getMonth(), 1);

        const s = safeDate(modelStartEl && modelStartEl.value) || defaultStart;
        const e = safeDate(modelEndEl && modelEndEl.value) || today;

        const series = getModelSeriesByRange(s, e);
        modelChart.data.labels = series.labels;
        modelChart.data.datasets[0].data = series.values;
        modelChart.update();
      }

      // init default values so chart isn't empty
      (function initModelDateDefaults(){
        const today = new Date();
        const start = new Date(today.getFullYear(), today.getMonth(), 1);
        if (modelStartEl && !modelStartEl.value) modelStartEl.value = toYMD(start);
        if (modelEndEl && !modelEndEl.value) modelEndEl.value = toYMD(today);
      })();

      if (modelStartEl) modelStartEl.addEventListener('change', updateModelChart);
      if (modelEndEl) modelEndEl.addEventListener('change', updateModelChart);
      updateModelChart();

      // ========= Section 3: Forklifts per Agent (stacked by model) =========
      const sfStartEl = document.getElementById('saleForkStartDate');
      const sfEndEl = document.getElementById('saleForkEndDate');
      const sfModeEl = document.getElementById('saleForkAgentFilter');
      const saleForkCanvas = document.getElementById('saleForkliftChart');

      // Add individual sale options into sfModeEl (so user can pick 1 sale)
      function ensureAgentOptionsInForkFilter() {
        if (!sfModeEl) return;
        const existing = new Set(Array.from(sfModeEl.options).map(o => o.value));
        sales.forEach((s) => {
          if (existing.has(s)) return;
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          sfModeEl.appendChild(opt);
        });
      }

      let saleForkChart = null;
      if (saleForkCanvas && hasChart) {
        saleForkChart = new Chart(saleForkCanvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: [],
            datasets: [
              { label: 'LHE', data: [], backgroundColor: 'rgba(31, 111, 178, 0.85)', borderWidth: 0 },
              { label: 'LPE', data: [], backgroundColor: 'rgba(255, 122, 26, 0.85)', borderWidth: 0 },
              { label: 'RRE', data: [], backgroundColor: 'rgba(100, 116, 139, 0.45)', borderWidth: 0 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true, position: 'bottom' }, tooltip: { enabled: true } },
            scales: {
              x: { stacked: true, grid: { display: false } },
              y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } }
            }
          }
        });
      }

      function getAgentsForForkChart() {
        const mode = sfModeEl ? sfModeEl.value : 'ALL';
        if (mode === '__use_main__') return getSelectedAgents();
        if (mode === 'ALL') return sales.slice();
        if (mode) return [mode];
        return sales.slice();
      }

      function updateAgentForkChart() {
        if (!saleForkChart) return;

        const today = new Date();
        const defaultStart = new Date(today.getFullYear(), today.getMonth(), 1);

        const s = safeDate(sfStartEl && sfStartEl.value) || defaultStart;
        const e = safeDate(sfEndEl && sfEndEl.value) || today;

        const sTime = Math.min(s.getTime(), e.getTime());
        const eTime = Math.max(s.getTime(), e.getTime());

        const salesToShow = getAgentsForForkChart();
        const agg = {};
        salesToShow.forEach(sale => { agg[sale] = { LHE: 0, LPE: 0, RRE: 0 }; });

        saleForkTx.forEach((item) => {
          if (!agg[item.sale]) return;
          const d = new Date(item.date);
          const t = d.getTime();
          if (t < sTime || t > eTime) return;
          agg[item.sale][item.model] += (+item.qty || 0);
        });

        saleForkChart.data.labels = salesToShow;
        saleForkChart.data.datasets[0].data = salesToShow.map(sale => agg[sale].LHE || 0);
        saleForkChart.data.datasets[1].data = salesToShow.map(sale => agg[sale].LPE || 0);
        saleForkChart.data.datasets[2].data = salesToShow.map(sale => agg[sale].RRE || 0);
        saleForkChart.update();
      }

      // Defaults for forklift chart date range
      (function initForkDateDefaults(){
        if (sfStartEl && !sfStartEl.value) {
          const today = new Date();
          const start = new Date(today.getFullYear(), today.getMonth(), 1);
          sfStartEl.value = toYMD(start);
        }
        if (sfEndEl && !sfEndEl.value) sfEndEl.value = toYMD(new Date());
      })();

      if (sfStartEl) sfStartEl.addEventListener('change', updateAgentForkChart);
      if (sfEndEl) sfEndEl.addEventListener('change', updateAgentForkChart);
      if (sfModeEl) sfModeEl.addEventListener('change', updateAgentForkChart);

      // ========= Wire main buttons =========
      if (applyBtn) applyBtn.addEventListener('click', () => { updateAgentCompare(); updateAgentForkChart();  updateForkliftSummary(startEl && startEl.value, endEl && endEl.value, getSelectedSales ? getSelectedSales() : (typeof getSelectedAgents==='function'?getSelectedAgents():[])); updateForkliftCompareChart(startEl && startEl.value, endEl && endEl.value, getSelectedSales ? getSelectedSales() : (typeof getSelectedAgents==='function'?getSelectedAgents():[])); });
      if (resetBtn) resetBtn.addEventListener('click', () => {
        const today = new Date();
        const yyyy = today.getFullYear();
        if (startEl) startEl.value = `${yyyy}-01-01`;
        if (endEl) endEl.value = toYMD(today);

        if (saleSelect) Array.from(saleSelect.options).forEach(o => o.selected = true);
        if (saleDropdownList) Array.from(saleDropdownList.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = true);
        updateAgentDropdownLabel();

        // reset forklift filter to follow main
        if (sfModeEl) sfModeEl.value = '__use_main__';

        updateAgentCompare();
        updateAgentForkChart();
      });

      // ========= Init everything =========
      populateHiddenAgentSelect();
      initAgentDropdown();

    // ---------- Forklift Filters (date range + multi-select) ----------
    const forkliftStartEl = document.getElementById('forkliftStartDate');
    const forkliftEndEl = document.getElementById('forkliftEndDate');
    const forkliftSelect = document.getElementById('forkliftMultiSelect');

    const forkliftMultiDropdown = document.getElementById('forkliftDropdown');
    const forkliftDropdownBtn = document.getElementById('forkliftDropdownBtn');
    const forkliftDropdownPanel = document.getElementById('forkliftDropdownPanel');
    const forkliftDropdownList = document.getElementById('forkliftDropdownList');
    const forkliftSelectAllBtn = document.getElementById('forkliftSelectAllBtn');
    const forkliftClearBtn = document.getElementById('forkliftClearBtn');

    const forkliftUpdateBtn = document.getElementById('forkliftUpdateBtn');
    const forkliftResetBtn = document.getElementById('forkliftResetBtn');

    function getSelectedForkliftNames() {
      if (!forkliftDropdownList) return [];
      return Array.from(forkliftDropdownList.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);
    }

    function setForkliftBtnLabel() {
      if (!forkliftDropdownBtn) return;
      const selected = getSelectedForkliftNames();
      const total = (sales || []).length;
      let text = `เลือก Agent`;
      if (!selected.length || selected.length === total) text = `เลือก Agent (ทั้งหมด)`;
      else if (selected.length === 1) text = selected[0];
      else text = `${selected.length} คน`;
      forkliftDropdownBtn.innerHTML = `${text} <span class="mdrop-caret">▾</span>`;
    }

    function initForkliftDropdown() {
      if (!forkliftMultiDropdown || !forkliftDropdownBtn || !forkliftDropdownPanel || !forkliftDropdownList || !forkliftSelect) return;

      // seed dates from main filter (if any)
      if (forkliftStartEl && startEl && startEl.value) forkliftStartEl.value = startEl.value;
      if (forkliftEndEl && endEl && endEl.value) forkliftEndEl.value = endEl.value;

      forkliftSelect.innerHTML = '';
      forkliftDropdownList.innerHTML = '';

      (sales || []).forEach((name) => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        opt.selected = true;
        forkliftSelect.appendChild(opt);

        const row = document.createElement('label');
        row.className = 'mdrop-item';
        row.innerHTML = `<input type="checkbox" checked value="${name}" /> <span>${name}</span>`;
        forkliftDropdownList.appendChild(row);
      });

      setForkliftBtnLabel();

      const close = () => {
        forkliftMultiDropdown.classList.remove('open');
        forkliftDropdownBtn.setAttribute('aria-expanded', 'false');
      };
      const open = () => {
        forkliftMultiDropdown.classList.add('open');
        forkliftDropdownBtn.setAttribute('aria-expanded', 'true');
      };

      forkliftDropdownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        forkliftMultiDropdown.classList.contains('open') ? close() : open();
      });
      forkliftDropdownPanel.addEventListener('click', (e) => e.stopPropagation());
      document.addEventListener('click', () => close());

      forkliftDropdownList.addEventListener('change', () => setForkliftBtnLabel());

      if (forkliftSelectAllBtn) forkliftSelectAllBtn.addEventListener('click', () => {
        Array.from(forkliftDropdownList.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = true);
        setForkliftBtnLabel();
      });
      if (forkliftClearBtn) forkliftClearBtn.addEventListener('click', () => {
        Array.from(forkliftDropdownList.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = false);
        setForkliftBtnLabel();
      });

      const runUpdate = () => {
        const s = forkliftStartEl ? forkliftStartEl.value : '';
        const e = forkliftEndEl ? forkliftEndEl.value : '';
        const sel = getSelectedForkliftNames();
        if (typeof updateForkliftSummary === 'function') updateForkliftSummary(s, e, sel);
        if (typeof updateForkliftCompareChart === 'function') updateForkliftCompareChart(s, e, sel);
      };

      if (forkliftUpdateBtn) forkliftUpdateBtn.addEventListener('click', runUpdate);

      if (forkliftResetBtn) forkliftResetBtn.addEventListener('click', () => {
        if (forkliftStartEl) forkliftStartEl.value = '';
        if (forkliftEndEl) forkliftEndEl.value = '';
        Array.from(forkliftDropdownList.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = true);
        setForkliftBtnLabel();
        runUpdate();
      });

      // first run
      runUpdate();
    }

    initForkliftDropdown();
      ensureAgentOptionsInForkFilter();

      updateAgentCompare();
      updateModelChart();
      updateAgentForkChart();

      // --- Forklift quotation vs service summary (uses quoteForkTx vs saleForkTx) ---
      function inRangeISO(dateStr, startStr, endStr) {
        if (!dateStr) return false;
        if (startStr && dateStr < startStr) return false;
        if (endStr && dateStr > endStr) return false;
        return true;
      }

      function sumForkliftsBySale(saleName, startStr, endStr) {
        let qFork = 0;
        let sFork = 0;

        quoteForkTx.forEach((t) => {
          if (t.sale !== saleName) return;
          if (!inRangeISO(t.date, startStr, endStr)) return;
          qFork += (+t.qty || 0);
        });

        saleForkTx.forEach((t) => {
          if (t.sale !== saleName) return;
          if (!inRangeISO(t.date, startStr, endStr)) return;
          sFork += (+t.qty || 0);
        });

        return { sale: saleName, qFork, sFork };
      }

      function renderForkliftChips(rows) {
    const el = document.getElementById('forkliftSummaryChips');
    if (!el) return;

    const totalQ = rows.reduce((a, r) => a + r.qFork, 0);
    const totalS = rows.reduce((a, r) => a + r.sFork, 0);
    const successRate = totalQ ? ((totalS / totalQ) * 100) : 0;

    const topQ = rows.slice().sort((a, b) => b.qFork - a.qFork)[0];
    const topText = topQ ? `${topQ.sale} 🏆 Top • ${topQ.qFork} รถ(ใบเสนอราคา) / ${topQ.sFork} รถ(สัญญา)` : '-';

    el.innerHTML = `
      <div style="padding: 0.75rem 1rem; background:#f3f8ff; border-radius:12px; border:1px solid #dbeafe;">
        <div style="font-size: 0.75rem; color:#64748b; margin-bottom:0.25rem;">สรุปช่วงวันที่เลือก (รวมทีม)</div>
        <div style="font-size:0.95rem; font-weight:800; color:var(--primary-color);">${totalQ.toLocaleString()} รถในใบเสนอราคา / ${totalS.toLocaleString()} รถในสัญญา</div>
      </div>

      <div style="padding: 0.75rem 1rem; background:#fff7ed; border-radius:12px; border:1px solid #fed7aa;">
        <div style="font-size: 0.75rem; color:#9a3412; margin-bottom:0.25rem;">Top Performer</div>
        <div style="font-size:0.95rem; font-weight:800; color:#c2410c;">${topText}</div>
        <div style="font-size:0.78rem; color:#9a3412;">ตามช่วงวันที่เลือก</div>
      </div>

      <div style="padding: 0.75rem 1rem; background:#ecfdf5; border-radius:12px; border:1px solid #bbf7d0;">
        <div style="font-size: 0.75rem; color:#065f46; margin-bottom:0.25rem;">อัตราการทำสัญญาบริการสำเร็จ</div>
        <div style="font-size: 1.05rem; font-weight:900; color:#047857;">${successRate.toFixed(1)}%</div>
        <div style="font-size:0.78rem; color:#065f46; font-weight:700;">ใบเสนอราคา ${totalQ.toLocaleString()} / สัญญาบริการ ${totalS.toLocaleString()}</div>
      </div>

      <div style="padding: 0.75rem 1rem; background:#ffffff; border-radius:12px; border:1px solid #e5edf8;">
        <div style="font-size: 0.75rem; color:#64748b; margin-bottom:0.25rem;">รถยก (รวมทีม)</div>
        <div style="display:flex; gap:0.6rem; align-items:baseline; flex-wrap:wrap;">
          <div style="font-size:0.9rem; font-weight:800; color:var(--primary-color);">ใบเสนอราคา: ${totalQ.toLocaleString()}</div>
          <div style="font-size:0.9rem; font-weight:800; color:var(--secondary-color);">สัญญา: ${totalS.toLocaleString()}</div>
        </div>
        <div style="font-size:0.78rem; color:#64748b;">คัน</div>
      </div>
    `;

    }

  function renderForkliftTable(rows) {
        const tbody = document.getElementById('forkliftSummaryTbody');
        if (!tbody) return;

        const sorted = rows.slice().sort((a, b) => (b.sFork - a.sFork) || (b.qFork - a.qFork));
        tbody.innerHTML = sorted.map((r, i) => {
          const rate = r.qFork ? ((r.sFork / r.qFork) * 100) : 0;
          return `
            <tr>
              <td style="text-align:center;">${i + 1}</td>
              <td style="font-weight:700;">${r.sale}</td>
              <td style="text-align:right;">${r.qFork.toLocaleString()}</td>
              <td style="text-align:right;">${r.sFork.toLocaleString()}</td>
              <td style="text-align:right; font-weight:800; color:var(--primary-color);">${rate.toFixed(1)}%</td>
            </tr>
          `;
        }).join('');
      }
      // ---------- Forklift compare chart (Quotation vs Service) ----------
      const forkliftCompareCanvas = document.getElementById('forkliftCompareChart');
      var forkliftCompareChart = null;

      if (forkliftCompareCanvas && hasChart) {
        forkliftCompareChart = new Chart(forkliftCompareCanvas.getContext('2d'), {
          type: 'bar',
          data: { labels: [], datasets: [
            { label: 'รถยกในใบเสนอราคา', data: [], backgroundColor: 'rgba(31, 111, 178, 0.85)', borderWidth: 0 },
            { label: 'รถยกในสัญญาบริการ', data: [], backgroundColor: 'rgba(255, 122, 26, 0.85)', borderWidth: 0 }
          ]},
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true, position: 'bottom' }, tooltip: { enabled: true } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
          }

        });
      }

            function renderForkliftCompareFallback(qTotal, sTotal) {
        const host = document.getElementById('forkliftCompareFallback');
        if (!host) return;

        const q = Number(qTotal) || 0;
        const s = Number(sTotal) || 0;
        const max = Math.max(q, s, 1);

        const qPct = Math.round((q / max) * 100);
        const sPct = Math.round((s / max) * 100);

        host.innerHTML = `
          <div class="chart-bars" style="height:180px; justify-content:flex-start; gap:2.0rem;">
            <div class="chart-bar-col" style="flex:0 0 72px;">
              <div class="chart-value">${q.toLocaleString()}</div>
              <div class="chart-bar-outer" style="max-width:44px;">
                <div class="chart-bar contracts" style="height:${qPct}%;"></div>
              </div>
              <div class="chart-label" style="width:72px;">รถยกใบเสนอราคา</div>
            </div>

            <div class="chart-bar-col" style="flex:0 0 72px;">
              <div class="chart-value">${s.toLocaleString()}</div>
              <div class="chart-bar-outer" style="max-width:44px;">
                <div class="chart-bar revenue" style="height:${sPct}%;"></div>
              </div>
              <div class="chart-label" style="width:72px;">รถยกสัญญา</div>
            </div>
          </div>
        `;
      }
      function sumForkQtyBySaleInRange(tx, sale, sTime, eTime) {
        let total = 0;
        tx.forEach((item) => {
          if (item.sale !== sale) return;
          const t = new Date(item.date).getTime();
          if (t < sTime || t > eTime) return;
          total += (+item.qty || 0);
        });
        return total;
      }

      function updateForkliftCompareChart(startStr, endStr, selectedSales) {
        // หาก Chart.js ไม่พร้อม ให้แสดง fallback แทน

        const s = safeDate(startStr) || safeDate((startEl && startEl.value)) || new Date(new Date().getFullYear(), 0, 1);
        const e = safeDate(endStr) || safeDate((endEl && endEl.value)) || new Date();
        const sTime = Math.min(s.getTime(), e.getTime());
        const eTime = Math.max(s.getTime(), e.getTime());

        const names = (selectedSales && selectedSales.length) ? selectedSales : sales.slice();

        const qData = names.map((n) => sumForkQtyBySaleInRange(quoteForkTx, n, sTime, eTime));
        const sData = names.map((n) => sumForkQtyBySaleInRange(saleForkTx, n, sTime, eTime));

        const qTotal = qData.reduce((a, b) => a + (Number(b) || 0), 0);
        const sTotal = sData.reduce((a, b) => a + (Number(b) || 0), 0);
        // ถ้า Chart.js พร้อม ให้ใช้กราฟ Chart.js (รูปแบบเดียวกับกราฟด้านบน)
        const fallbackHost = document.getElementById('forkliftCompareFallback');
        const forkliftCompareCanvas = document.getElementById('forkliftCompareChart');
        if (forkliftCompareChart && typeof forkliftCompareChart.update === 'function') {
          if (fallbackHost) fallbackHost.style.display = 'none';
          if (forkliftCompareCanvas) forkliftCompareCanvas.style.display = 'block';

          forkliftCompareChart.data.labels = names;
          forkliftCompareChart.data.datasets[0].data = qData.map(v => Number(v) || 0);
          forkliftCompareChart.data.datasets[1].data = sData.map(v => Number(v) || 0);
          forkliftCompareChart.update();
        } else {
          // ถ้า Chart.js ไม่พร้อม ให้แสดง fallback แทน (ยังเห็นกราฟแน่นอน)
          if (fallbackHost) fallbackHost.style.display = 'block';
          if (forkliftCompareCanvas) if (forkliftCompareCanvas) forkliftCompareCanvas.style.display = 'none';
          renderForkliftCompareFallback(qTotal, sTotal);
        }
if (!forkliftCompareChart) return;
        forkliftCompareChart.data.labels = names;
        forkliftCompareChart.data.datasets[0].data = qData;
        forkliftCompareChart.data.datasets[1].data = sData;
        forkliftCompareChart.update();
      }



      function updateForkliftSummary(startStr, endStr, selectedSales) {
        const names = (selectedSales && selectedSales.length) ? selectedSales : Object.keys(saleMonthly);
        const rows = names.map((name) => sumForkliftsBySale(name, startStr, endStr));
        renderForkliftChips(rows);
        renderForkliftTable(rows);
      }
      // init forklift summary + forklift compare chart once
      try {
        const s0 = startEl && startEl.value;
        const e0 = endEl && endEl.value;
        const selected0 = (typeof getSelectedSales === 'function') ? getSelectedSales() : (typeof getSelectedAgents === 'function' ? getSelectedAgents() : []);
        if (typeof updateForkliftSummary === 'function') updateForkliftSummary(s0, e0, selected0);
        if (typeof updateForkliftCompareChart === 'function') updateForkliftCompareChart(s0, e0, selected0);
      } catch (e) {}
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const dropdowns = document.querySelectorAll('.sale-dropdown');

  dropdowns.forEach(dropdown => {
    const btn = dropdown.querySelector('.sale-toggle-btn');
    const menu = dropdown.querySelector('.sale-dropdown-menu');

    if (!btn || !menu) return;

    btn.addEventListener('click', function (e) {
      e.stopPropagation();

      // close other dropdowns first
      dropdowns.forEach(d => {
        if (d !== dropdown) d.classList.remove('open');
      });

      dropdown.classList.toggle('open');
    });
  });

  // click outside -> close all
  document.addEventListener('click', function () {
    dropdowns.forEach(d => d.classList.remove('open'));
  });
});
</script>
</div></body>
</html>
